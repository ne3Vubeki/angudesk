var fs = require("fs"),
	url = require("url"),
	formidable = require('formidable'),
	mime = require('mime'),
    HTTP_SERVER = "http\\";
    pages = function() {
        var cacheData = {},
            resp200 = function(response, file, pathname) {
                response.writeHead(200, {"Content-Type": mime.lookup(pathname)});
                response.write(file);
                response.end();
            },
            resp500 = function(response, error) {
                console.log(error);
                response.writeHead(500, {"Content-Type": "text/plain"});
                response.write(error + "\n");
                response.end();
            };
        return {
            start: function(response) {
                if(cacheData.indexHtml) {
                    resp200(response, cacheData.indexHtml, 'index.html');
                }
                else {
                    fs.readFile(HTTP_SERVER + "index.html", function(error, file) {
                        if(error) {
                            resp500(response, error);
                        } else {
                            resp200(response, file, 'index.html');
                            cacheData.indexHtml = file;
                        }
                    });
                }
            },
            link: function(response, request) {
                var pathname = url.parse(request.url).pathname;
                if (cacheData[pathname]) {
                    resp200(response, cacheData[pathname], pathname);
                    console.log("File " + pathname + " was loaded from cache.");
                }
                else {
                    fs.readFile(HTTP_SERVER + pathname, function (error, file) {
                        if (error) {
                            resp500(response, error);
                        } else {
                            resp200(response, file, pathname);
                            cacheData[pathname] = file;
                            console.log("File " + pathname + " was loaded.");
                        }
                    });
                }
            }
        };
    }();




function upload(response, request) {
    console.log("Request handler 'upload' was called.");
	var form = new formidable.IncomingForm();
	console.log("about to parse");
	form.parse(request, function(error, fields, files) {
		console.log("parsing done");

		/* Возможна ошибка в Windows: попытка переименования уже существующего файла */
		fs.rename(files.upload.path, "/tmp/test.jpg", function(err) {
			console.log(err);
			if (err) {
				fs.unlink("/tmp/test.jpg");
				fs.rename(files.upload.path, "/tmp/test.jpg");
			}
		});
		response.writeHead(200, {"Content-Type": "text/html"});
		response.write("received image:<br/>");
		response.write("<img src='/show' />");
		response.end();
	});
}

function show(response) {
	console.log("Request handler 'show' was called.");
	fs.readFile("/tmp/test.jpg", "binary", function(error, file) {
		if(error) {
			response.writeHead(500, {"Content-Type": "text/plain"});
			response.write(error + "\n");
			response.end();
		} else {
			response.writeHead(200, {"Content-Type": "image/jpeg"});
			response.write(file, "binary");
			response.end();
		}
	});
}

exports.pages = pages;
exports.upload = upload;
exports.show = show;